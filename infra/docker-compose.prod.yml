# TelemetryX - Production Stack (for EC2)
# ============================================
# Uses AWS RDS for Postgres and ElastiCache for Redis
# Images are pulled from AWS ECR
#
# Usage: docker compose -f docker-compose.prod.yml up -d
# ============================================

services:
  # Rust: Event Ingestion Service
  rust-ingestion:
    image: ${ECR_REGISTRY}/telemetryx-ingestion:${IMAGE_TAG:-latest}
    container_name: telemetryx-ingestion
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - telemetryx-network

  # Rust: REST + WebSocket API
  rust-api:
    image: ${ECR_REGISTRY}/telemetryx-api:${IMAGE_TAG:-latest}
    container_name: telemetryx-api
    restart: unless-stopped
    ports:
      - "8081:8081"
      - "8082:8082"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      GRPC_ENDPOINT: http://python-brain:50051
      REST_HOST: 0.0.0.0
      REST_PORT: 8081
      WS_PORT: 8082
    depends_on:
      - python-brain
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - telemetryx-network

  # Python: Brain (Rules Engine + ML)
  python-brain:
    image: ${ECR_REGISTRY}/telemetryx-brain:${IMAGE_TAG:-latest}
    container_name: telemetryx-python-brain
    restart: unless-stopped
    ports:
      - "50051:50051"
    environment:
      PYTHON_ENV: ${PYTHON_ENV:-production}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: 50051
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 50051)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - telemetryx-network

networks:
  telemetryx-network:
    name: telemetryx-network
    driver: bridge
